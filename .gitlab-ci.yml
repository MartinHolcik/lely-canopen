variables:
  GIT_STRATEGY: clone
  REGISTRY: $CI_REGISTRY_IMAGE

cache:
  key: none
  paths: []
  policy: pull

stages:
  - docker1
  - docker2
  - build
  - test
  - deploy

.docker:
  tags:
    - docker
    - linux
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build
        --build-arg REGISTRY=$REGISTRY
        -t $CI_REGISTRY_IMAGE/$NAME:$TAG docker/$NAME/$TAG
    - docker push $CI_REGISTRY_IMAGE/$NAME:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - docker/**/*
      when: always

.docker1:
  extends: .docker
  stage: docker1

.docker2:
  extends: .docker
  stage: docker2

.build:
  stage: build
  tags:
    - docker
    - linux
  needs: []
  script:
    - autoreconf -i
    - ./configure $CONFIGURE_OPTIONS
    - make
  artifacts:
    untracked: true

.test:
  stage: test
  tags:
    - docker
    - linux
  script:
    - touch aclocal.m4 configure config.status Makefile.in
    - make -t
    - make check
  artifacts:
    when: on_failure
    paths:
      - test/test-*.log
    expire_in: 1 week

.docker-gcc:
  extends: .docker1
  script:
    - docker build
        --build-arg __GNUC__=$__GNUC__
        -t $CI_REGISTRY_IMAGE/gcc:$__GNUC__ docker/gcc
    - docker push $CI_REGISTRY_IMAGE/gcc:$__GNUC__

docker-gcc:4:
  extends: .docker-gcc
  variables:
    __GNUC__: 4

build:gcc:4:
  extends: .build
  image: $REGISTRY/gcc:4

test:gcc:4:
  extends: .test
  image: $REGISTRY/gcc:4
  needs: ["build:gcc:4"]

docker-gcc:5:
  extends: .docker-gcc
  variables:
    __GNUC__: 5

build:gcc:5:
  extends: .build
  image: $REGISTRY/gcc:5

test:gcc:5:
  extends: .test
  image: $REGISTRY/gcc:5
  needs: ["build:gcc:5"]

docker-gcc:6:
  extends: .docker-gcc
  variables:
    __GNUC__: 6

build:gcc:6:
  extends: .build
  image: $REGISTRY/gcc:6

test:gcc:6:
  extends: .test
  image: $REGISTRY/gcc:6
  needs: ["build:gcc:6"]

docker-gcc:7:
  extends: .docker-gcc
  variables:
    __GNUC__: 7

build:gcc:7:
  extends: .build
  image: $REGISTRY/gcc:7

test:gcc:7:
  extends: .test
  image: $REGISTRY/gcc:7
  needs: ["build:gcc:7"]

docker-gcc:8:
  extends: .docker-gcc
  variables:
    __GNUC__: 8

build:gcc:8:
  extends: .build
  image: $REGISTRY/gcc:8

test:gcc:8:
  extends: .test
  image: $REGISTRY/gcc:8
  needs: ["build:gcc:8"]

docker-gcc:9:
  extends: .docker-gcc
  variables:
    __GNUC__: 9

build:gcc:9:
  extends: .build
  image: $REGISTRY/gcc:9

test:gcc:9:
  extends: .test
  image: $REGISTRY/gcc:9
  needs: ["build:gcc:9"]

docker-gcc:10:
  extends: .docker-gcc
  variables:
    __GNUC__: 10

build:gcc:10:
  extends: .build
  image: $REGISTRY/gcc:10

test:gcc:10:
  extends: .test
  image: $REGISTRY/gcc:10
  needs: ["build:gcc:10"]

build:gcc:no-canfd:
  extends: .build
  image: $REGISTRY/gcc:10
  variables:
    CONFIGURE_OPTIONS: --disable-canfd

test:gcc:no-canfd:
  extends: .test
  image: $REGISTRY/gcc:10
  needs: ["build:gcc:no-canfd"]

build:gcc:no-cxx:
  extends: .build
  image: $REGISTRY/gcc:10
  variables:
    CONFIGURE_OPTIONS: --disable-cxx

test:gcc:no-cxx:
  extends: .test
  image: $REGISTRY/gcc:10
  needs: ["build:gcc:no-cxx"]

build:gcc:no-master:
  extends: .build
  image: $REGISTRY/gcc:10
  variables:
    CONFIGURE_OPTIONS: --disable-master

test:gcc:no-master:
  extends: .test
  image: $REGISTRY/gcc:10
  needs: ["build:gcc:no-master"]

.docker-mingw-w64:
  extends: .docker1
  script:
    - docker build
        --build-arg ARCH=$ARCH
        -t $CI_REGISTRY_IMAGE/$ARCH-w64-mingw32:$TAG docker/mingw-w64/$TAG
    - docker push $CI_REGISTRY_IMAGE/$ARCH-w64-mingw32:$TAG

docker:i686-w64-mingw32:
  extends: .docker-mingw-w64
  variables:
    ARCH: i686
    TAG: bullseye

build:i686-w64-mingw32:
  extends: .build
  image: $REGISTRY/i686-w64-mingw32:bullseye
  variables:
    CONFIGURE_OPTIONS: --host=i686-w64-mingw32 --disable-python

test:i686-w64-mingw32:
  extends: .test
  image: $REGISTRY/i686-w64-mingw32:bullseye
  needs: ["build:i686-w64-mingw32"]

docker:x86_64-w64-mingw32:
  extends: .docker-mingw-w64
  variables:
    ARCH: x86_64
    TAG: bullseye

build:x86_64-w64-mingw32:
  extends: .build
  image: $REGISTRY/x86_64-w64-mingw32:bullseye
  variables:
    CONFIGURE_OPTIONS: --host=x86_64-w64-mingw32 --disable-python

test:x86_64-w64-mingw32:
  extends: .test
  image: $REGISTRY/x86_64-w64-mingw32:bullseye
  needs: ["build:x86_64-w64-mingw32"]

.docker-crossbuild:
  extends: .docker1
  script:
    - docker build
        --build-arg ARCH=$ARCH
        --build-arg NAME=$NAME
        -t $CI_REGISTRY_IMAGE/$NAME:$TAG docker/crossbuild/$TAG
    - docker push $CI_REGISTRY_IMAGE/$NAME:$TAG

docker:arm-linux-gnueabihf:
  extends: .docker-crossbuild
  variables:
    ARCH: armhf
    NAME: arm-linux-gnueabihf
    TAG: buster

build:arm-linux-gnueabihf:
  extends: .build
  image: $REGISTRY/arm-linux-gnueabihf:buster
  variables:
    ARCH: armhf
    CONFIGURE_OPTIONS: --host=arm-linux-gnueabihf

test:arm-linux-gnueabihf:
  extends: .test
  image: $REGISTRY/arm-linux-gnueabihf:buster
  needs: ["build:arm-linux-gnueabihf"]
  variables:
    ARCH: armhf

docker:aarch64-linux-gnu:
  extends: .docker-crossbuild
  variables:
    ARCH: arm64
    NAME: aarch64-linux-gnu
    TAG: buster

build:aarch64-linux-gnu:
  extends: .build
  image: $REGISTRY/aarch64-linux-gnu:buster
  variables:
    ARCH: arm64
    CONFIGURE_OPTIONS: --host=aarch64-linux-gnu

test:aarch64-linux-gnu:
  extends: .test
  image: $REGISTRY/aarch64-linux-gnu:buster
  needs: ["build:aarch64-linux-gnu"]
  variables:
    ARCH: arm64

docker:build:
  extends: .docker1
  variables:
    NAME: build
    TAG: bullseye

docker:arm-none-eabi:
  extends: .docker2
  needs: ["docker:build"]
  variables:
    NAME: arm-none-eabi
    TAG: bullseye

build:arm-none-eabi:
  extends: .build
  image: $REGISTRY/arm-none-eabi:bullseye
  variables:
    CFLAGS: -g -O2 -mcpu=cortex-m3 -D__NEWLIB__
    CONFIGURE_OPTIONS: --host=arm-none-eabi --disable-tools --disable-tests --disable-python --disable-threads --disable-daemon
    CXXFLAGS: -g -O2 -mcpu=cortex-m3 -D__NEWLIB__
    LDFLAGS: --specs=nosys.specs

docker:doc:
  extends: .docker2
  needs: ["docker:build"]
  variables:
    NAME: doc
    TAG: bullseye

doc:
  stage: build
  tags:
    - docker
    - linux
  image: $REGISTRY/doc:bullseye
  needs: []
  script:
    - autoreconf -i
    - ./configure
    - make html
  artifacts:
    paths:
      - doc/
    expire_in: 1 week

docker:cpplint:
  extends: .docker1
  variables:
    NAME: cpplint
    TAG: bullseye

cpplint:
  stage: test
  tags:
    - docker
    - linux
  image: $REGISTRY/cpplint:bullseye
  script:
    - python2 $(which cpplint.py)
        --quiet
        --extensions=cpp
        $(find include -name *.hpp)
        $(find src -name *.cpp)

docker:valgrind:
  extends: .docker2
  needs: ["docker:build"]
  variables:
    NAME: valgrind
    TAG: bullseye

valgrind:
  stage: test
  tags:
    - docker
    - linux
  image: $REGISTRY/valgrind:bullseye
  needs: []
  script:
    - autoreconf -i
    - ./configure --disable-python
    - make
    - make check-valgrind-memcheck
  artifacts:
    when: on_failure
    paths:
      - test/test-*.log
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: always
    - if: '$CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"'
      when: always
    - when: manual
      allow_failure: true

docker:lcov:
  extends: .docker2
  needs: ["docker:build"]
  variables:
    NAME: lcov
    TAG: bullseye

lcov:
  stage: test
  tags:
    - docker
    - linux
  image: $REGISTRY/lcov:bullseye
  needs: []
  script:
    - autoreconf -i
    - ./configure --enable-code-coverage --disable-shared
    - make
    - make check-code-coverage
    - lcov --summary coverage.info --rc lcov_branch_coverage=1
  artifacts:
    paths:
      - coverage/
    expire_in: 1 week

docker:scan-build:
  extends: .docker2
  needs: ["docker:build"]
  variables:
    NAME: scan-build
    TAG: bullseye

scan-build:
  stage: test
  tags:
    - docker
    - linux
  image: $REGISTRY/scan-build:bullseye
  needs: []
  script:
    - autoreconf -i
    - scan-build ./configure --disable-python
    - scan-build --keep-cc -o ./scan-build make check
  artifacts:
    when: on_failure
    paths:
      - scan-build/
    expire_in: 1 week

docker:cppcheck-unix64:
  extends: .docker2
  needs: ["docker:build"]
  variables:
    NAME: cppcheck-unix64
    TAG: bullseye

cppcheck-unix64:
  stage: test
  tags:
    - docker
    - linux
  image: $REGISTRY/cppcheck-unix64:bullseye
  needs: []
  script:
    - autoreconf -i
    - ./configure --disable-python
    - cppcheck --doc > cppcheck-rules.md
    - cppcheck
        -D_GNU_SOURCE -D__linux__=1 -DHAVE_CONFIG_H
        --enable=warning,style,performance,portability,missingInclude
        --error-exitcode=1
        --force
        --quiet
        -I. -I./include
        --inline-suppr
        --platform=unix64
        --std=c11 --std=c++11
        --library=std --library=gnu
        --suppressions-list=suppressions.txt
        -isrc/io2/win32
        include src
  when: manual

docker:cppcheck-win64:
  extends: .docker2
  needs: ["docker:x86_64-w64-mingw32"]
  variables:
    NAME: cppcheck-win64
    TAG: bullseye

cppcheck-win64:
  stage: test
  tags:
    - docker
    - linux
  image: $REGISTRY/cppcheck-win64:bullseye
  needs: []
  script:
    - autoreconf -i
    - ./configure --host=x86_64-w64-mingw32 --disable-python
    - cppcheck --doc > cppcheck-rules.md
    - cppcheck
        -D_WIN32=1 -D_WIN64=1 -D__MINGW32__=1 -D__MINGW64__=1 -DHAVE_CONFIG_H
        -U__linux__
        --enable=warning,style,performance,portability,missingInclude
        --error-exitcode=1
        --force
        --quiet
        -I. -I./include
        --inline-suppr
        --platform=win64
        --std=c11 --std=c++11
        --library=std --library=gnu --library=windows
        --suppress=va_list_usedBeforeStarted
        --suppressions-list=suppressions.txt
        -isrc/io2/linux
        include src
  when: manual

docker:coverity:
  extends: .docker1
  script:
    - docker build
        --build-arg REGISTRY=$REGISTRY
        --build-arg COVERITY_PROJECT=$COVERITY_PROJECT
        --build-arg COVERITY_TOKEN=$COVERITY_TOKEN
        -t $CI_REGISTRY_IMAGE/coverity:gcc9 docker/coverity/gcc9
    - docker push $CI_REGISTRY_IMAGE/coverity:gcc9

coverity:
  stage: test
  tags:
    - docker
    - linux
  image: $REGISTRY/coverity:gcc9
  needs: []
  script:
    - autoreconf -i
    - ./configure --disable-python
    - cov-build --dir cov-int make check
  after_script:
    - tar caf $CI_PROJECT_NAME.xz cov-int
    - curl --form token=$COVERITY_TOKEN
        --form email=$COVERITY_EMAIL
        --form file=@$CI_PROJECT_NAME.xz
        --form version="$(git describe --abbrev=0 --tags | sed s/^v//)"
        --form description="$CI_COMMIT_REF_NAME"
        https://scan.coverity.com/builds?project=$COVERITY_PROJECT
  when: manual

pages:
  stage: deploy
  tags:
    - docker
    - linux
  image: alpine:latest
  needs: ["doc", "lcov"]
  script:
    - mkdir -p public
    - mv coverage public/lcov
    - mv doc/html public/doxygen
  artifacts:
    paths:
      - public
    expire_in: 1 weeks
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: always
    - when: never
